<script lang="ts">
    import { trpcWithQuery } from "$lib/trpc/client";

    import { page } from "$app/stores";

    import TokenProvider from "$lib/components/providers/token-provider.svelte";

    import { SOL } from "$lib/xray";
    import { LAMPORTS_PER_SOL } from "@solana/web3.js";
    import formatMoney from "$lib/util/format-money";
    import Icon from "$lib/components/icon.svelte";

    export let account: string = "";

    const client = trpcWithQuery($page);

    const balances = client.balances.createQuery(account, {
        refetchOnMount: false,
        refetchOnWindowFocus: false,
    });

    const token2022 = client.token2022.createQuery(account, {
        refetchOnMount: false,
        refetchOnWindowFocus: false,
    });

    const sol = client.price.createQuery(SOL);

    $: sorted = $balances?.data?.tokens
        // @ts-ignore
        ?.filter(({ decimals, amount }) => decimals && amount)
        .slice(0, $token2022.data ? 2 : 3)
        // @ts-ignore
        .sort(
            (
                { amount: a, decimals: ad, symbol },
                { amount: b, decimals: bd }
            ) =>
                a / 10 ** ad < b / 10 ** bd ||
                symbol !== "SOL" ||
                symbol !== "USDC"
                    ? 1
                    : -1
        );
</script>

<div class="">
    <div class="my-3 flex items-center justify-between">
        <h2 class="text-2xl font-bold">Tokens</h2>

        <a
            href="/account/{account}/tokens"
            class="btn btn-secondary btn-sm text-xs"
        >
            VIEW ALL
        </a>
    </div>

    <a
        class="mb-2 grid grid-cols-12 items-center gap-3 rounded-lg border bg-black p-1 hover:border-primary"
        href="/token/{SOL}"
    >
        <div class="col-span-2 p-1">
            <!-- background so that if it doesn't load you dont' get ugly no image icons -->
            <div
                style="background-image: url(/media/tokens/solana.png)"
                class="aspect-square w-full rounded-lg bg-cover"
            />
        </div>
        <div class="col-span-10 flex items-center justify-between text-right">
            <div>
                <h4 class="font-semibold md:text-sm">SOL</h4>
            </div>
            <div>
                {#if $balances.data?.nativeBalance}
                    <h4 class="font-semibold md:text-sm">
                        {(
                            $balances.data?.nativeBalance / LAMPORTS_PER_SOL
                        ).toLocaleString()}
                    </h4>
                {/if}

                <h4 class="text-xs opacity-50">
                    {#if $sol.data}
                        {formatMoney(
                            ($sol.data * $balances.data?.nativeBalance) /
                                LAMPORTS_PER_SOL
                        )}
                    {/if}
                </h4>
            </div>
        </div>
    </a>

    {#if $token2022.data}
        {#each $token2022.data as token}
            <TokenProvider
                address={token.mint}
                let:metadata
            >
                <a
                    class="mb-2 grid grid-cols-12 items-center gap-3 rounded-lg border bg-black p-1 pr-3 hover:border-primary"
                    href="/token/{token.mint}"
                >
                    <div class="col-span-2 p-1">
                        <!-- background so that if it doesn't load you dont' get ugly no image icons -->
                        <div
                            style="background-image: url('{metadata.image}')"
                            class="aspect-square w-full rounded-lg bg-cover"
                        />
                    </div>
                    <div
                        class="col-span-10 flex items-center justify-between text-right"
                    >
                        <div>
                            <h4 class="text-left font-semibold md:text-xs">
                                {metadata?.name || "Unknown"}
                            </h4>
                        </div>
                        <div>
                            <h4 class="font-semibold md:text-sm">
                                {token.amount.toLocaleString()}
                            </h4>
                        </div>
                    </div>
                </a>
            </TokenProvider>
        {/each}
    {/if}
    {#if sorted}
        {#each sorted as token (token.mint)}
            {#if token.decimals > 0 && token.mint !== SOL}
                <TokenProvider
                    address={token.mint}
                    let:metadata
                >
                    <a
                        class="mb-2 grid grid-cols-12 items-center gap-2 rounded-lg border bg-black p-1 pr-3 hover:border-primary"
                        href="/token/{token.mint}"
                    >
                        <div class="col-span-2 p-1">
                            <!-- background so that if it doesn't load you dont' get ugly no image icons -->
                            <div
                                style="background-image: url('{metadata.image}')"
                                class="aspect-square w-full rounded-lg bg-cover"
                            />
                        </div>
                        <div
                            class="col-span-10 flex items-center justify-between text-right"
                        >
                            <div>
                                <h4 class="text-left font-semibold md:text-xs">
                                    {metadata?.name || ""}
                                </h4>
                            </div>
                            <div>
                                <h4 class="font-semibold md:text-sm">
                                    {(
                                        token.amount /
                                        10 ** token.decimals
                                    ).toLocaleString()}
                                </h4>
                                <h4 class="text-xs opacity-50">
                                    {#if metadata.price}
                                        {formatMoney(
                                            (metadata.price * token.amount) /
                                                10 ** token.decimals
                                        )}
                                    {/if}
                                </h4>
                            </div>
                        </div>
                    </a>
                </TokenProvider>
            {/if}
        {/each}
    {:else}
        {#each Array(3) as _}
            <div
                class="mb-3 grid animate-pulse grid-cols-12 items-center gap-3 rounded-lg"
            >
                <div
                    class="col-span-12 flex items-center justify-between md:col-span-11"
                >
                    <div>
                        <div
                            class="mb-2 h-3 w-32 animate-pulse rounded-full bg-secondary"
                        />
                        <div
                            class="h-2 w-20 animate-pulse rounded-full bg-secondary"
                        />
                    </div>
                    <div
                        class="h-2 w-5 animate-pulse rounded-full bg-secondary"
                    />
                </div>
            </div>
        {/each}
    {/if}
</div>
